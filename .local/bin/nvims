#!/usr/bin/env bash
# Define Neovim applications you want to experiment with.

# The repository clonded must bootstrap itself.  In otherwords, clone and nvim
# is all tha tis needed.
#
# alias      | url,url#relative_path              | default or branch name
#            | url->subdir (symlink mode)         |
#
# Symlink mode: Clone repo to ~/github/<repo-name>/
#               Create symlink ~/.config/<alias> -> repo/<subdir>
readonly neovim_apps=(
  "nvchad          | https://github.com/NvChad/NvChad,git@github.com:isvicy/NvChadCustom.git#lua/custom   | default"
  "lazyvim         | https://github.com/LazyVim/starter                                                   | default"
  "pwnvim          | https://github.com/pwnwriter/pwnvim.git                                              | main"
  "kickstarter     | https://github.com/nvim-lua/kickstart.nvim.git                                       | master"
  "minimal         | https://github.com/rezhaTanuharja/minimalistNVIM.git                                 | main"
  "neobean         | https://github.com/linkarzu/dotfiles-latest.git->neovim/neobean                      | main"
  "default         | git@github.com:isvicy/nvim-no-distro.git                                             | main"
)

# File name that is overwritten with nvim appname aliases.
readonly nvimAppNameFile="$HOME"/.nvim_appnames

# nvapp names extracted from neovim_apps array.
nvapps=()

# Working directory
dir=$(pwd)

# --------------------------------------------------------------------------
#  Determine if a pull is needed.

# Yo huutube: nvims: Demonstrate suppressed shellcheck error.
# shellcheck disable=SC2120
gitcheck() {

  # Git variables used to determine if a pull is needed.
  git fetch
  upstream=${1:-'@{u}'}
  local=$(git rev-parse @)
  remote=$(git rev-parse "$upstream")
  base=$(git merge-base @ "$upstream")

  if [[ "$local" == "$remote" ]]; then
    echo "Up-to-date"
  elif [[ "$remote" == "$base" ]]; then
    echo "Need-to-Push"
  elif [[ "$local" == "$base" ]]; then
    echo "Need-to-Pull"
  else
    echo "Diverged"
  fi
}

# --------------------------------------------------------------------------
#  Remove all spaces from parameter 1.

removeSpaces() {
  var="$(echo -e "$1" | tr -d '[:space:]')"
  echo "$var"
}

# --------------------------------------------------------------------------
#  Extract fields from neovim_app array.

buildNeovimAppArray() {
  for fields in "${neovim_apps[@]}"; do
    IFS=$'|' read -r alias _url _branch <<<"$fields"
    alias="$(removeSpaces "$alias")"
    nvapps+=("$alias")
  done
}

# --------------------------------------------------------------------------
#  Repo storage directory for symlink mode
readonly nvimRepoDir="$HOME/github"

# --------------------------------------------------------------------------
#  Clone or Pull selected nvapp

cloneOrPullNvApp() {
  for fields in "${neovim_apps[@]}"; do
    IFS=$'|' read -r alias urls branch <<<"$fields"

    alias="$(removeSpaces "$alias")"
    if [[ ${alias} == "default" ]]; then
      alias=""
    fi
    if [[ "$1" == "${alias}" ]]; then
      if [[ ${alias} == "" ]]; then
        alias="nvim"
      fi
      urls="$(removeSpaces "$urls")"
      branch="$(removeSpaces "$branch")"
      IFS=',' read -ra addrs <<<"$urls"
      for addrInfo in "${addrs[@]}"; do
        # Check for symlink mode (->)
        if [[ "$addrInfo" == *"->"* ]]; then
          url="${addrInfo%%->*}"
          subdir="${addrInfo#*->}"
          cloneOrPullSymlink "$alias" "$url" "$branch" "$subdir"
        else
          IFS='#' read -r url path <<<"$addrInfo"
          location=$HOME/.config/$alias/$path
          if [[ -d "$location" ]]; then
            pullRepository "$alias" $location
          else
            cloneRepository "$alias" "$url" "$branch" "$location"
          fi
        fi
      done
    fi
  done
}

# --------------------------------------------------------------------------
#  Clone or Pull for symlink mode

cloneOrPullSymlink() {
  local alias="$1"
  local url="$2"
  local branch="$3"
  local subdir="$4"
  # Extract repo name from URL (e.g., dotfiles-latest from .../dotfiles-latest.git)
  local repoName="${url##*/}"
  repoName="${repoName%.git}"
  local repoLocation="$nvimRepoDir/$repoName"
  local configLocation="$HOME/.config/$alias"

  # Ensure repo directory exists
  mkdir -p "$nvimRepoDir"

  if [[ -d "$repoLocation" ]]; then
    # Pull existing repo
    pullRepository "$alias" "$repoLocation"
  else
    # Clone new repo
    cloneRepository "$alias" "$url" "$branch" "$repoLocation"
  fi

  # Create symlink if not exists
  if [[ ! -L "$configLocation" ]]; then
    # Remove directory if exists (but not symlink)
    if [[ -d "$configLocation" ]]; then
      echo "Warning: $configLocation exists as directory, removing..."
      rm -rf "$configLocation"
    fi
    ln -s "$repoLocation/$subdir" "$configLocation"
    echo "Created symlink: $configLocation -> $repoLocation/$subdir"
  fi
}

# --------------------------------------------------------------------------
#  Pull repository

pullRepository() {
  alias="$1"
  location="$2"
  runCommandFromDirectory "$location" "git pull"
}

# --------------------------------------------------------------------------
#  Clone Repository

cloneRepository() {
  alias="$1"
  url="$2"
  branch="$3"
  location="$4"

  git clone "$url" "$location"
  if [[ $branch != "default" ]]; then
    runCommandFromDirectory "$location" "git checkout $branch"
  fi
}

# --------------------------------------------------------------------------
#  Recursively remove directory if present.

removeDirIfPresent() {
  if [[ -d "$1" ]]; then
    echo "Removed $1"
    rm -rf "$1"
  fi
}

# --------------------------------------------------------------------------
#  Remove symlink if present

removeSymlinkIfPresent() {
  if [[ -L "$1" ]]; then
    echo "Removed symlink $1"
    rm "$1"
  fi
}

# --------------------------------------------------------------------------
#  Delete NvimApp from $HOME/.config directory

deleteNvimApp() {
  for fields in "${neovim_apps[@]}"; do
    IFS=$'|' read -r alias urls branch <<<"$fields"

    alias="$(removeSpaces "$alias")"
    if [[ ${alias} == "default" ]]; then
      alias=""
    fi
    if [[ "$1" == "${alias}" ]]; then
      if [[ ${alias} == "" ]]; then
        alias="nvim"
      fi
      echo "Deleting $alias if required."
      urls="$(removeSpaces "$urls")"
      branch="$(removeSpaces "$branch")"
      IFS=',' read -ra addrs <<<"$urls"
      for addrInfo in "${addrs[@]}"; do
        # Check for symlink mode (->)
        if [[ "$addrInfo" == *"->"* ]]; then
          url="${addrInfo%%->*}"
          deleteSymlinkNvimApp "$alias" "$url"
        else
          IFS='#' read -r url path <<<"$addrInfo"
          location=$HOME/.config/$alias/$path
          removeDirIfPresent "$location"
        fi
      done
      removeDirIfPresent "$HOME"/.cache/"$alias"
      removeDirIfPresent "$HOME"/.local/share/"$alias"
      removeDirIfPresent "$HOME"/.local/state/"$alias"
    fi
  done
}

# --------------------------------------------------------------------------
#  Delete symlink mode NvimApp

deleteSymlinkNvimApp() {
  local alias="$1"
  local url="$2"
  local configLocation="$HOME/.config/$alias"
  # Extract repo name from URL
  local repoName="${url##*/}"
  repoName="${repoName%.git}"
  local repoLocation="$nvimRepoDir/$repoName"

  # Remove symlink
  removeSymlinkIfPresent "$configLocation"
  # Remove repo directory
  removeDirIfPresent "$repoLocation"
}

# --------------------------------------------------------------------------
#  Run a command from another directory.

runCommandFromDirectory() {
  location="$1"
  command="$2"

  cd "$location" || return

  if [[ "$(runCommandCheck "$command")" == true ]]; then
    echo "$command"
    $command
  fi

  toWorkingDirectory
}

# --------------------------------------------------------------------------
#  Avoid unnecessary pull commands.

runCommandCheck() {
  command="$1"
  run_command=true

  if [[ "$command" == "git pull" ]]; then
    if [[ "$(gitcheck)" != "Need-to-Pull" ]]; then
      run_command=false
    fi
  fi

  echo "$run_command"
}

# --------------------------------------------------------------------------
#  Move to working directory.

toWorkingDirectory() {
  cd "$dir" || (echo "Returning to working directory failed." && exit)
}

# --------------------------------------------------------------------------
#  Write neovim aliases to a file that can be sourced.

writeAliasesFile() {
  echo "# NVIM_APPNAME aliases" >>"$nvimAppNameFile"
  for nvapp in "${nvapps[@]}"; do
    if [[ "default" != "$nvapp" ]]; then
      echo alias nvim-"${nvapp}"=\"NVIM_APPNAME="$nvapp" nvim\" >>"$nvimAppNameFile"
    fi
  done
}

# --------------------------------------------------------------------------
#  Select Neovim app to switch to.

selectNeovimApp() {
  config=$(
    printf "%s\n" "${nvapps[@]}" |
      fzf --prompt=" Neovim Config  " \
        --height=35% --layout=reverse --border --exit-0
  )

  if [[ -z $config ]]; then
    echo "Nothing selected"
  elif [[ $config == "default" ]]; then
    config=""
  fi
  echo "$config"
}

# --------------------------------------------------------------------------
#  Get command line arguments.
#     d : delete nvimapp selected
#     h || invalid : display usage
#     Normal nvims operation for anything else

deleteNvimAppFlag=false
while getopts 'dh' option; do
  case "$option" in
  d)
    deleteNvimAppFlag=true
    ;;
  h)
    echo "Usage: nvims [] [-d] [-h]"
    exit 1
    ;;
  *)
    printf "Usage: nvims [] [-d] [-h]\n"
    exit 1
    ;;
  esac
done

# -- -----------------------------------------------------------------------
#  Main logic

main() {
  buildNeovimAppArray
  writeAliasesFile
  choice="$(selectNeovimApp)"

  if [[ "$choice" == "Nothing selected" ]]; then
    echo "Invalid choice. Exiting" && exit
  fi

  if [[ $deleteNvimAppFlag == true ]]; then
    deleteNvimApp "$choice"
  else
    cloneOrPullNvApp "$choice"
    NVIM_APPNAME="$choice" nvim "$@"
  fi
}

# --------------------------------------------------------------------------
main "$@"
